// Generated by CoffeeScript 1.9.3
var addmsg, chatevents, sendMsg, waitForMsg;

chatevents = null;

addmsg = function(type, msg) {
  return $("#chat").append(msg);
};

waitForMsg = function() {
  return $.ajax({
    type: "GET",
    url: "/hivemind/chatslave",
    async: true,
    cache: false,
    data: {
      action: "poll"
    },
    timeout: 50000,
    success: function(data) {
      addmsg("new", data);
      return setTimeout(waitForMsg, 3000);
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      addmsg("error", textStatus + " (" + errorThrown + ")");
      return setTimeout(waitForMsg, 15000);
    }
  });
};

sendMsg = function() {
  return $.ajax({
    type: "POST",
    url: "/hivemind/publish",
    async: true,
    cache: false,
    data: {
      action: "msg",
      msg: $("#chatbox").val()
    },
    success: function() {
      return $("#chatbox").val("");
    }
  });
};

$(document).ready(function() {
  $("#chatbox").keypress(function(e) {
    if (e.which === 13) {
      return sendMsg();
    }
  });
  $("#chatbox_button").mousedown(function(e) {
    return sendMsg();
  });
  chatevents = new EventSource('/hivemind/sseslave');
  return chatevents.addEventListener('message', (function(e) {
    return alert(e.data);
  }), false);
});
